<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Todo App</title>
    <style>
        body { font-family: Arial; margin: 20px; }
        input[type="text"], select { padding: 5px; margin: 5px; }
        button { padding: 5px 10px; margin: 5px; }
        .todo-item { display: flex; align-items: center; margin: 5px 0; }
        .todo-item.completed span { text-decoration: line-through; color: gray; }
        .btn-delete { background-color: red; color: white; border: none; padding: 5px 10px; margin-left: 10px; cursor: pointer; }
        .btn-complete { background-color: blueviolet; color: white; border: none; padding: 5px 10px; margin-left: 5px; cursor: pointer; }
        #todoContainer {
            border: 2px solid #ccc;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>

    <h2>Todo Web</h2>
  
    <div id="authContainer">
    <h3>Giriş Yap / Kayıt Ol</h3>

    <input type="text" id="authUsername" placeholder="Kullanıcı adı" />
    <input type="password" id="authPassword" placeholder="Şifre" />
    <button onclick="login()">Giriş Yap</button>
    <button onclick="register()">Kayıt Ol</button>
    <button onclick="logout()">Çıkış Yap</button>

    <p id="authMessage"></p>
    </div>

    <hr/>

    
    <input type="text" id="searchInput" placeholder="Search" />
        <select id="listFilter">
        <option value="all">All</option>
        <option value="list1">List 1</option>
        <option value="list2">List 2</option>
    </select>

    <select id="statusFilter">
        <option value="all">All</option>
        <option value="completed">Completed</option>
        <option value="pending">Pending</option>
    </select>
    <button onclick="applyFilters()">Search</button>

    <br><br/>
        <input type="text" id="newListInput" placeholder="Yeni liste adı" />
        <button onclick="addNewList()">Liste Ekle</button>
    <br/><br/>
  
    <input type="text" id="newTodoInput" placeholder="Yeni todo" />
    <select id="todoListSelect">
        <option value="list1">List 1</option>
        <option value="list2">List 2</option>
    </select>
    <button onclick="addNewTodo()">Todo Ekle</button>
  
    <div id="todoContainer"></div>

<script>
    
    let todos = [];

    async function fetchTodos() {
        const res = await fetch("/todos");
        todos = await res.json();
        applyFilters();
    }

    async function toggleComplete(id) {
        const todo = todos.find(t => t.id === id);
        if (!todo) return;

        await fetch(`/todos/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ completed: !todo.completed }),
        });

        fetchTodos();
    }


    async function deleteTodo(id) {
        const todo = todos.find(t => t.id === id);
        if (!todo) return;

        if (!todo.completed) {
            const confirmDelete = confirm("Uyarı! Bu todoyu daha tamamlamadınız. Silmek istediğinizden emin misiniz?");
            if (!confirmDelete) return;
        }

        await fetch(`/todos/${id}`, {
            method: "DELETE"
        });

        fetchTodos();
    }

    async function register() {
        const username = document.getElementById("authUsername").value;
        const password = document.getElementById("authPassword").value;

        const res = await fetch("/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
        });

        const data = await res.json();
        document.getElementById("authMessage").textContent = data.success ? "✅ Kayıt başarılı, şimdi giriş yap." : `❌ ${data.error || "Kayıt başarısız"}`;
    }

    async function login() {
        const username = document.getElementById("authUsername").value;
        const password = document.getElementById("authPassword").value;

        const res = await fetch("/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
        });

        const data = await res.json();
        if (data.success) {
            document.getElementById("authMessage").textContent = "✅ Giriş başarılı.";
            fetchTodos();
        } else {
            document.getElementById("authMessage").textContent = `❌ ${data.error || "Giriş başarısız"}`;
        }
    }

    async function logout() {
        const res = await fetch("/logout", { method: "POST" });
        const data = await res.json();
        if (data.success) {
            document.getElementById("authMessage").textContent = "👋 Çıkış yapıldı.";
            fetchTodos();
        }
    }

    
    function addNewList() {
        const input = document.getElementById("newListInput");
        const listName = input.value.trim();
        if (!listName) return;

        const listFilter = document.getElementById("listFilter");
        const newOption = document.createElement("option");
        newOption.value = listName;
        newOption.textContent = listName;
        listFilter.appendChild(newOption);

        const todoListSelect = document.getElementById("todoListSelect");
        const newOption2 = document.createElement("option");
        newOption2.value = listName;
        newOption2.textContent = listName;
        todoListSelect.appendChild(newOption2);

        input.value = "";
    }

    async function addNewTodo() {
        const text = document.getElementById("newTodoInput").value.trim();
        const list = document.getElementById("todoListSelect").value;

        if (!text) return;

        await fetch("/todos", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text, list }),
        });

        document.getElementById("newTodoInput").value = "";
        fetchTodos();
    }


    function applyFilters() {
        const search = document.getElementById("searchInput").value.toLowerCase();
        const listFilter = document.getElementById("listFilter").value;
        const statusFilter = document.getElementById("statusFilter").value;

        const filtered = todos.filter(todo => {
        const matchesSearch = todo.text.toLowerCase().includes(search);
        const matchesList = listFilter === "all" || todo.list === listFilter;
        const matchesStatus =
        statusFilter === "all" ||
            (statusFilter === "completed" && todo.completed) ||
            (statusFilter === "pending" && !todo.completed);
            return matchesSearch && matchesList && matchesStatus;
        });

        renderTodos(filtered);
    }

    function renderTodos(filtered = todos) {
    const container = document.getElementById("todoContainer");
    container.innerHTML = '';
    filtered.forEach(todo => {
        const div = document.createElement("div");
        div.className = "todo-item" + (todo.completed ? " completed" : "");
        div.innerHTML = `
            <input type="checkbox" ${todo.completed ? "checked" : ""} onchange="toggleComplete(${todo.id})"/>
            <span>${todo.text}</span>
            <button class="btn-delete" onclick="deleteTodo(${todo.id})">Delete</button>
            <button class="btn-complete" onclick="toggleComplete(${todo.id})">Complete</button>
            `;
        container.appendChild(div);
        });
    }

    fetchTodos();

</script>
</body>
</html>
